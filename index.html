<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Auto Document PiP</title>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}
button{
  padding:14px 22px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
  background:#22c55e;
  color:black;
  font-size:16px;
}
</style>
</head>
<body>

<button id="start">Iniciar Sistema</button>

<!-- vÃ­deo invisÃ­vel 1x1 -->
<video id="hiddenVideo" autoplay muted playsinline width="1" height="1" style="position:absolute;left:-9999px;"></video>

<script>
let pipWindow = null;
let systemArmed = false;

const btn = document.getElementById("start");
const video = document.getElementById("hiddenVideo");

btn.addEventListener("click", async () => {

  // Criar canvas invisÃ­vel 1x1
  const canvas = document.createElement("canvas");
  canvas.width = 1;
  canvas.height = 1;

  const ctx = canvas.getContext("2d");

  function keepAlive(){
    ctx.fillRect(0,0,1,1);
    requestAnimationFrame(keepAlive);
  }
  keepAlive();

  const stream = canvas.captureStream(1);
  video.srcObject = stream;

  systemArmed = true;
  btn.textContent = "Sistema Ativo";

  alert("Agora troque de aba ðŸ˜‰");
});

async function openPiP(){

  if (!systemArmed) return;
  if (pipWindow) return;
  if (!("documentPictureInPicture" in window)) return;

  pipWindow = await documentPictureInPicture.requestWindow({
    width: 320,
    height: 200
  });

  pipWindow.document.body.innerHTML = `
    <style>
      body{
        margin:0;
        background:#111827;
        color:white;
        font-family:Arial;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
      }
      .status{
        font-size:18px;
        margin-bottom:15px;
      }
      .dot{
        width:12px;
        height:12px;
        background:#22c55e;
        border-radius:50%;
        animation:pulse 1s infinite;
      }
      @keyframes pulse{
        0%{opacity:1;}
        50%{opacity:.3;}
        100%{opacity:1;}
      }
    </style>

    <div class="status">LigaÃ§Ã£o Ativa</div>
    <div class="dot"></div>
  `;

  pipWindow.addEventListener("pagehide", () => {
    pipWindow = null;
  });
}

function closePiP(){
  if (pipWindow){
    pipWindow.close();
    pipWindow = null;
  }
}

// Detecta troca de aba
document.addEventListener("visibilitychange", () => {

  if (!systemArmed) return;

  if (document.hidden){
    openPiP();
  } else {
    closePiP();
  }
});

</script>
</body>
</html>